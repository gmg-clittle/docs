---
title: Market Value Savings Widget
description: Injects MSRP and savings data for used vehicles on SRPs using Dealer.com API and external pricing API.
---

import CodeBlock from '@theme/CodeBlock';

# Market Value Savings Widget

This script dynamically injects a "Market Based Price" and savings pill for used vehicles on the Search Results Page (SRP), powered by a remote API that provides MSRP values.

## How It Works

- Listens for the `page-load-v1` event to confirm you're on the SRP.
- Subscribes to `vehicle-data-updated-v1` to react to inventory data availability.
- Fetches VINs and inventory types, filtering only `used` vehicles.
- Calls a remote API for MSRP values.
- Injects a pricing banner showing MSRP and calculated savings below each vehicle with valid pricing data.

## Script

<CodeBlock language="javascript">

(async APILoader => {
  const API = await APILoader.create();

  API.subscribe('page-load-v1', event => {
    if (!event.payload.searchPage) return;

    API.subscribe('vehicle-data-updated-v1', async () => {
      const vins = await API.utils.getAttributeForVehicles('vin');
      const types = await API.utils.getAttributeForVehicles('inventoryType');
      const usedVins = vins.filter((_, i) => types[i] === 'used');

      if (!usedVins.length) return;

      try {
        const response = await fetch(
          \`https://cors-rosy.vercel.app/api/srp-garber-buick-gmc-market-value?vin=\${usedVins.join(',')}\`
        );
        const marketData = await response.json();
        const marketMap = Object.fromEntries(marketData.map(v => [v.vin, v.msrp]));

        API.insertOnce('vehicle-payments', (elem, meta) => {
          const vin = meta.vin;
          const msrp = parseFloat(marketMap[vin]);
          const finalPrice = parseFloat(meta.finalPrice);

          if (!vin || !msrp || !finalPrice || isNaN(msrp) || isNaN(finalPrice)) return;

          const savings = msrp - finalPrice;
          if (savings <= 0) return;

          const formattedMsrp = \`$\${msrp.toLocaleString()}\`;
          const formattedSavings = \`$\${savings.toLocaleString()}\`;

          const container = document.createElement('div');
          container.className = 'market-pricing-info';
          container.style.cssText = \`
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: Inter, sans-serif;
            font-size: 13px;
            font-weight: 500;
            width: 100%;
            background-color: #f9f9f9;
            padding: 4px 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            flex-wrap: nowrap;
            gap: 8px;
          \`;

          const priceLine = document.createElement('div');
          priceLine.innerHTML = \`
            <span style="color: #c00;">Market Based Price:</span>
            <span style="color: #c00; text-decoration: line-through;"> \${formattedMsrp}</span>
          \`;

          const savingsPill = document.createElement('div');
          savingsPill.innerText = \`Save \${formattedSavings}\`;
          savingsPill.style.cssText = \`
            background-color: #28a745;
            color: white;
            font-weight: 500;
            font-size: 10px;
            border-radius: 12px;
            padding: 2px 8px;
            white-space: nowrap;
            margin-left: auto;
          \`;

          container.appendChild(priceLine);
          container.appendChild(savingsPill);
          API.append(elem, container);
        });
      } catch (error) {
        console.error('Error fetching market value data:', error);
      }
    });
  });
})(window.DDC.APILoader);

</CodeBlock>

## Styling Output

- **Market Based Price** is shown in red with a line-through.
- **Savings Pill** appears as a green pill indicating the amount saved off MSRP.

## Requirements

- Must be embedded on Dealer.com SRP.
- External API must support VIN-based MSRP lookups.
- Final price must be accessible via `meta.finalPrice`.

---

For advanced customization, consider adding additional styles, fallback logic, or MSRP label translations.
